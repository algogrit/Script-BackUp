#!/usr/bin/env bash
set -e

# Defaults
max_size=$((2 * 1024 * 1024))   # 2 MiB
resize="612x800"
quality=55
min_quality=20
out="out.pdf"
no_convert=0

usage() {
    cat <<EOF
shrinktopdf - Convert or combine images into a PDF under a target size

Usage: shrinktopdf [options] files...

Modes:
  Default: convert + compress + shrink to target size.
  -N, --no-convert: merge images AS-IS (no resize/quality/conversion).

Options:
  -o <file>        Output PDF (default: out.pdf)
  -s <bytes>       Max PDF size (default: 2097152 = 2MiB)
  -r <WxH>         Resize (default: 612x800)
  -q <num>         Starting quality (default: 55)
  -m <num>         Minimum quality (default: 20)
  -N, --no-convert Do not convert/resize/compress images; merge them as-is (Recover using: 'pdfimages -all out.pdf extracted')
  -h, --help       Show help

You may place options anywhere, even after filenames.
EOF
    exit 0
}

# Manual option parsing to allow "options anywhere"
inputs=()
while [[ $# -gt 0 ]]; do
    case "$1" in
        -o)
            out="$2"; shift 2 ;;
        -s)
            max_size="$2"; shift 2 ;;
        -r)
            resize="$2"; shift 2 ;;
        -q)
            quality="$2"; shift 2 ;;
        -m)
            min_quality="$2"; shift 2 ;;
        -N|--no-convert)
            no_convert=1; shift ;;
        -h|--help)
            usage ;;
        --)
            shift
            # Everything after -- is input
            while [[ $# -gt 0 ]]; do inputs+=("$1"); shift; done
            break ;;
        -*)
            echo "Unknown option: $1"
            exit 1 ;;
        *)
            # Positional input file
            inputs+=("$1"); shift ;;
    esac
done

# No inputs?
if [[ ${#inputs[@]} -eq 0 ]]; then
    echo "Error: No input images provided."
    echo "Use: shrinktopdf [options] files..."
    exit 1
fi

# AS-IS merge mode
if [[ $no_convert -eq 1 ]]; then
    echo "ðŸ“„ Creating PDF from images as-is..."
    magick "${inputs[@]}" "$out"

    size=$(stat -c%s "$out" 2>/dev/null || stat -f%z "$out")
    echo "âœ” Created $out ($((size/1024)) KiB) with no conversion."
    exit 0
fi

# Shrink mode
tmpdir=$(mktemp -d)
trap "rm -rf $tmpdir" EXIT

try_quality=$quality

while :; do
    rm -f "$out"

    # Convert inputs â†’ JPEGs
    for f in "${inputs[@]}"; do
        base=$(basename "$f")
        base="${base%.*}"

        magick "$f" -resize "$resize" -quality "$try_quality" \
            "$tmpdir/$base.jpg"
    done

    # Create PDF
    magick -density 72 "$tmpdir"/*.jpg \
        -compress JPEG -quality "$try_quality" "$out"

    # Size check
    size=$(stat -c%s "$out" 2>/dev/null || stat -f%z "$out")

    if [[ "$size" -lt "$max_size" ]]; then
        echo "âœ” Success: $out is $((size/1024)) KiB (quality=$try_quality)"
        exit 0
    fi

    echo "PDF too large ($((size/1024)) KiB). Lowering quality..."

    try_quality=$((try_quality - 5))
    if [[ "$try_quality" -lt "$min_quality" ]]; then
        echo "âœ˜ Could not shrink under $max_size bytes even at minimum quality."
        exit 1
    fi
done
